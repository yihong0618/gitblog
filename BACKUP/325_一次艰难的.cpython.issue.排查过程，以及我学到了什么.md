# [ä¸€æ¬¡è‰°éš¾çš„ cpython issue æ’æŸ¥è¿‡ç¨‹ï¼Œä»¥åŠæˆ‘å­¦åˆ°äº†ä»€ä¹ˆ](https://github.com/yihong0618/gitblog/issues/325)

## å¼•å­

æœ€è¿‘ä¾ç„¶åœ¨å°è¯•åšä¸€äº›å¤§æ¨¡å‹ç›®å‰åšä¸åˆ°çš„äº‹å„¿ï¼Œå»æ»¡è¶³ä¸€äº›å­˜åœ¨æ„Ÿã€‚ä½†æ˜¯ TiDB çš„ issues æ²¡æœ‰ä»¥å‰å¤šäº†ï¼Œæ°å¥½æŸä¸€å¤© @kemingy å‘ç° cpython æºç é‡Œæœ‰äº›å†™çš„ä¸å¥½çš„åœ°æ–¹ï¼Œæˆ‘æƒ³ cpython ä¹Ÿè®¸ä¹Ÿå¯ä»¥ï¼Ÿä½†æˆ‘ä¸‡ä¸‡æ²¡æƒ³åˆ°ä¸€ä¸ª patch è¿›å…¥åˆ° cpython æ˜¯å¤šä¹ˆçš„éš¾ï¼Œæˆ‘å·²ç»å‰å‰ååä¿®äº† 4 ä¸ª cpython çš„ bug ä½†æ˜¯æ¯ä¸ªéƒ½åœ¨è¿‡ç¨‹ä¸­ï¼Œè¿‡ç¨‹ä¸­å­¦åˆ°äº†ä¸å°‘ä¸œè¥¿ï¼Œä½†æ›´å¼€å¿ƒçš„æ˜¯è®¤è¯†åˆ°äº†ç›®å‰å³ä½¿æœ€å¼ºçš„å¤§æ¨¡å‹çš„å±€é™ã€‚

## bug ï¼Ÿ

- bug æ˜¯è¿™ä¸ª https://github.com/python/cpython/issues/134163

## å°è¯•çš„è¿‡ç¨‹

ä¸‹é¢æ˜¯æˆ‘å°è¯•çš„è¿‡ç¨‹ï¼Œå¦‚æœèƒ½åŒæ ·å¸®åˆ°å–œæ¬¢ bug çš„æœ‹å‹å°±æ›´å¥½äº†

1. å½“ç„¶æ˜¯å°è¯•å¤ç°ï¼Œ3.13 åœ¨ repl ä½¿ç”¨ issue ä¸­çš„è¯­å¥ hang, 3.14 ä¸ hang ä½ï¼Œæ˜¯ 3.13 only çš„é—®é¢˜
2. Claude Code å¯åŠ¨ï¼Œå…ˆè®©å¤§æ¨¡å‹å¸®æˆ‘å®šä½ä¸‹ï¼Œå¤§æ¨¡å‹å‰å‰ååèµ°äº†å‡ åœˆï¼Œéƒ½æ˜¯é”™çš„ï¼Œè€Œä¸”å¤§æ¨¡å‹çš„æ€è·¯æœ‰é—®é¢˜ï¼Œå®ƒè®¤ä¸º 3.14 ä¿®äº†å°±æ˜¯æœ‰çš„ commit ä¿®äº†ï¼Œå†ä¸åœçš„æŸ¥ commit
3. è‡ªå·±æ¥å§ï¼Œé¦–å…ˆå…ˆç¼©å°èŒƒå›´
    - åœ¨ repl é‡Œå¿…å¤ç°
    - ç›´æ¥ä½¿ç”¨ ./python xxx.py æ²¡äº‹
    - pty æ²¡äº‹å„¿
    - subprocess æ²¡äº‹
    - å§æ§½åªæœ‰ repl é‡Œï¼Ÿ
    - å¼ºåˆ¶ä½¿ç”¨æ—§ repl `PYTHON_BASIC_REPL=1 ./python` ä¹Ÿæ²¡äº‹å„¿ï¼
4. OK é‚£æ˜¯ new repl only, å®šä½å¥½äº†é—®é¢˜

## èƒ½å¤ç°å°±æ˜¯æˆåŠŸçš„ä¸€åŠï¼Ÿ

1. no è¿™ä¸ª issue å¹¶ä¸æ˜¯
2. è¿™ä¸ªæ˜¯ c å±‚é¢çš„è¿˜æ˜¯ python å±‚é¢çš„ï¼Ÿå› ä¸ºåªæœ‰åœ¨ new repl é‡Œæˆ‘å¼€å§‹ä»¥ä¸ºæ˜¯ python å±‚é¢çš„
3. åœ¨æ‰€æœ‰å¯èƒ½æ˜¯ memory error çš„åœ°æ–¹æ¥ä¸Š except: nothing work
4. åœ¨æºç é‡ŒåŠ  print å§æ§½åŠ ä¸Š print bug æ¶ˆå¤±äº†ï¼Œå¦ˆçš„
5. å› ä¸ºä¸Šæ¡æˆ‘æ€€ç–‘æˆ‘èµ°é”™è·¯äº†ï¼Œå¤§æ¦‚ç‡æ˜¯ c å±‚é¢çš„ï¼Œä½†æ˜¯æˆ‘å¾—å®šä½åˆ°å“ªä¸€è¡Œé€ æˆ c å±‚é¢çš„é”™è¯¯ 
6. å†ä¸€é¡¿ print debug ä¹‹åå‘ç°æ˜¯ console.py é‡Œçš„è¿™ä¸€è¡Œ `exec(code, self.locals)`
7. OK æ‰¾åˆ°è¿™ä¸ª bug å°±å¯ä»¥ç®€åŒ–ä¸ºåœ¨ new repl é‡Œæ‰§è¡Œ `exec("_testcapi.set_nomemory(0)")`

## ä½†æ˜¯ä½†æ˜¯

1. æˆ‘åœ¨ c å±‚é¢ä¸€è·¯æ‰¾ memroy ç›¸å…³çš„æ²¡å¤´ç»ªï¼Œèƒ½æ”¹çš„åœ°æ–¹éƒ½æ”¹äº†
2. è¿‡ç¨‹ä¸­è¿˜ç†Ÿæ‚‰äº†ä¸€ç‚¹ cpython çš„ä»£ç 
3. ä½†æ˜¯è¿˜æ˜¯ä¸è¡Œ

## å…ˆæ”¾å¼ƒäº†ï¼Œä½†è¿˜æƒ³ç€

- ç„¶åæˆ‘å°±æŠŠé—®é¢˜å…ˆæç½®äº†å»å¿™åˆ«çš„äº†
- ä½†æ˜¯è·‘æ­¥çš„è¿‡ç¨‹ä¸­çªç„¶æœ‰äº†ä¸€ç‚¹æƒ³æ³•ä¹Ÿè®¸ä¸æ˜¯ 3.13 only çš„
- git branch å¯åŠ¨ï¼å¯¹ä¸æ˜¯ï¼å‘ç° 3.14 ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä»ç„¶æœ‰è¿™ä¸ª bug
- é‚£ä¹ˆæ˜¯æŸä¸ªå° branch ç»™ä¿®äº†
- branch äºŒåˆ†æ³•å¯åŠ¨ï¼æœ€åå‘ç°æ˜¯ 3.14a2 -> 3.14a3 ä¹‹é—´æŸä¸ª commit ç»™æ„å¤–çš„ä¿®å¤äº†ï¼Ÿ
- æ—¢ç„¶ branch  èƒ½äºŒåˆ†æ³•æˆ‘çªç„¶æ‚Ÿåˆ°äº†å¯ä»¥ bisect
- ç¬¬ä¸€æ¬¡ç”¨ bisect åœ¨å¤§æ¨¡å‹çš„æ•™å­¦ä¸‹ä¸€è·¯æ‰¾ï¼ˆè¿™é‡Œæœ‰ä¸ªå‘å°±æ˜¯ good å’Œ bad æ˜¯åçš„ï¼‰æœ€åå‘ç°æ˜¯è¿™ä¸ª commit æ„å¤–çš„ç»™ä¿®äº† 5fc6bb2754a25157575efc0b37da78c629fea46e
- ä¿®çš„äººå¥½å¼ºå•Š
- èƒ½ cherry-pick ä¹ˆï¼Ÿä¸èƒ½ï¼å› ä¸ºæ”¹åŠ¨å¤ªå¤§äº†è¿™ä¹‹é—´çš„é‡Œ
- èƒ½å€Ÿä½ä»–ä¿®çš„ä¸€éƒ¨åˆ†ä¿®å¤ä¹ˆï¼Ÿä¸€è·¯å°è¯•ï¼Œæ˜¯ä¸èƒ½çš„ï¼Œå› ä¸ºæœ¬è´¨ä¸Šä¸æ˜¯ä¸€ä¸ªé—®é¢˜
- åˆå°è¯•äº†å¥½å¤šã€‚ã€‚ã€‚ä¹Ÿä¸è¡Œï¼Œç¡®æ€§äº† cpython é—ç•™çš„ bug éƒ½æ˜¯æœ‰éš¾åº¦çš„

## æ‰¾æœ‹å‹å§

- å½“ç„¶æ˜¯å…ˆæ‰¾@kemingy å¸®å¿™ï¼Œä»–æ¯”æˆ‘å¤šèµ°äº†ä¸¤æ­¥ä½†æ˜¯ä¹Ÿå¡ä½äº†
- æ‰¾ @frostming ä¹Ÿè¯•è¯•
- æš‚æ—¶æ²¡ç»“æœï¼Œæ—©ä¸Šçªç„¶æƒ³åˆ°æˆ‘è¦å» pycon çš„æœºç¥¨è¿˜åœ¨æ‹–å»¶ï¼Œä¸æƒ³éº»çƒ¦ gray å¸®å¿™äº† ï¼Œç­‰ä¸‹ @graymon çš„æ¼”è®²æ˜¯ gdb ç›¸å…³ä¹Ÿè®¸å¯ä»¥è¯•è¯•
- gdb å¯åŠ¨
- è¿™é‡Œä¹Ÿæœ‰ä¸ªå‘å¥½åƒ gdb ä¼šæ”¹å˜å†…å­˜
- ä½†æ˜¯æœ€åè¿˜æ˜¯æ‰¾åˆ°äº†æ˜¯åœ¨ /Python/ceval.c b/Python/ceval.c çš„ goto exception_unwind; é‡Œé™·å…¥äº†æ— é™çš„é€’å½’
- ä¿®å¤å¦‚æœé€’å½’ç›´æ¥ pyerr clear å§æ§½ä¸ hang äº†ä½†æ˜¯æ˜¯ Segmentation fault
- ç»§ç»­ï¼ŒæˆåŠŸäº†ï¼äºæ˜¯æœ‰äº†å¦‚ä¸‹ä¿®å¤
- æ„Ÿè°¢æœ‹å‹ä»¬çš„å¸®å¿™ï¼Œå¼€å¿ƒ

ä¿®å¤


```diff
diff --git a/Python/ceval.c b/Python/ceval.c
index 8c0cb29863c..3fe97a2c74c 100644
--- a/Python/ceval.c
+++ b/Python/ceval.c
@@ -912,7 +912,13 @@ _PyEval_EvalFrameDefault(PyThreadState *tstate, _PyInterpreterFrame *frame, int
                 int frame_lasti = _PyInterpreterFrame_LASTI(frame);
                 PyObject *lasti = PyLong_FromLong(frame_lasti);
                 if (lasti == NULL) {
-                    goto exception_unwind;
+                    // If we can't allocate memory for lasti during exception handling,
+                    // this likely means we're in a severe memory shortage situation.
+                    // Instead of going back to exception_unwind (which would cause
+                    // infinite recursion), directly exit to let the original exception
+                    // propagate up and hopefully be handled at a higher level.
+                    _PyFrame_SetStackPointer(frame, stack_pointer);
+                    goto exit_unwind;
                 }
                 PUSH(lasti);
             }
```

## ä¿®å¤çš„å¯¹ä¹ˆï¼Ÿ

- ä¸çŸ¥é“ï¼Œå…ˆè·‘æµ‹è¯• 3.13 éƒ½é€šè¿‡äº†
- main æœ‰è¿™ä¸ªé—®é¢˜ä¹ˆï¼Ÿæ²¡æœ‰ï¼Œä»£ç ç»“æ„éƒ½æ”¹äº†
- å¯¹ä¸å¯¹æˆ‘å…ˆæŠŠè¿‡ç¨‹åˆ†äº«å‡ºæ¥ï¼Œèƒ½è§£å†³ä¸€å¤§éƒ¨åˆ†ä¹Ÿæ˜¯å¼€å¿ƒçš„

## æ„Ÿæƒ³

- è°¢è°¢æœ‹å‹ä»¬
- å¤§æ¨¡å‹è¿˜æ˜¯æœ‰å±€é™çš„ä½†è¿˜æ˜¯èƒ½å¸®ä¸å°‘å¿™çš„
- gray å¥½å‰å®³
- cpython èƒ½é—ç•™ä¸‹æ¥çš„ bug éƒ½éå¸¸éš¾
- è¿˜æ˜¯å¼€å¿ƒ

---- update ----

https://t.me/c/1459082815/900

å’Œ gray å­¦ä¹ ã€‚

---

> å¤ªå‰å®³äº†ï¼å·²ç»å¼€å§‹ä¿® cpy äº†ï¼
> æ‰€ä»¥å¤§æ¨¡å‹ä¸€å¼€å§‹çš„æ€è·¯ä¹Ÿæ²¡é”™ï¼Œå°±æ˜¯æ‰¾ commit ã€‚åªæ˜¯æ²¡æ‰¾åˆ°ğŸ¤£

åº”è¯¥æ˜¯æ‰¾ä¸åˆ°çš„ï¼Œé‚£ä¸ªå±äºæ„å¤–çš„ä¿®äº†

---

> å­¦åˆ°å¾ˆå¤š å‘å¤§ä½¬å­¦ä¹ 

ä½ å¯ä»¥é‡ç‚¹çœ‹æœ€ä¸‹é¢çš„é“¾æ¥ gray ç‰¹åˆ«ç‰¹åˆ«å‰å®³

---

> `git bisect`ä¹Ÿå¯ä»¥ç”¨newå’Œoldæ ‡è®°

å­¦ä¹ äº†ï¼