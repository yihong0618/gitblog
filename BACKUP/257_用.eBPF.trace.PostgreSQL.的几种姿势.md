# [ç”¨ eBPF trace PostgreSQL çš„å‡ ç§å§¿åŠ¿](https://github.com/yihong0618/gitblog/issues/257)

![image](https://user-images.githubusercontent.com/15976103/215244978-a4c1cbd8-d1c3-4919-9ea1-425eb3061fe5.png)
## å‰

ç”¨ eBPF æ¥è§‚æµ‹ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºè¿™å‡ å¹´è¶Šæ¥è¶Šç«äº†ï¼Œè¯žç”Ÿäº†ä¸å°‘å¼€æºçš„åº”ç”¨ï¼Œä½†åœ¨æ•°æ®åº“è¿™ä¸ªé¢†åŸŸç›¸å…³çš„åº”ç”¨è¿˜ä¸ç®—å¤ªå¤šï¼Œç‰¹åˆ«æ˜¯ [PostgreSQL](https://www.postgresql.org/). 
åœ¨è¿™ä¸ªé¢†åŸŸä¹‹å‰æ²¡é‚£ä¹ˆå¤šäººç ”ç©¶å¯èƒ½çš„åŽŸå› ï¼š

1. æ•°æ®åº“å¼€å‘åœ¨å‰äº›å¹´è¿˜æ²¡åƒä»Šå¤©è¿™ä¹ˆçƒ­é—¨
2. PostgreSQL è‡ªå¸¦ dtrace åªéœ€è¦åœ¨ç¼–è¯‘æ—¶ --enable-dtrace å°±å¯ä»¥è¿›è¡Œä¸€äº›è§‚æµ‹
3. pg10 ä¹‹å‰åº”ç”¨ uprobe å¹¶ä¸å®¹æ˜“

## å‘å±•

### bcc
[bcc](https://github.com/iovisor/bcc) æ˜¯è‡ªå¸¦ mysql å’Œ postgres çš„ä¾‹å­çš„, å¯ä»¥è§‚æµ‹æ…¢æŸ¥è¯¢å’Œ latency ä½†é’ˆå¯¹ pg å¿…é¡»å¼€å¯ dtrace æ‰èƒ½ä½¿ç”¨
- tools/[dbslower](https://github.com/iovisor/bcc/blob/master/tools/dbslower.py): Trace MySQL/PostgreSQL queries slower than a threshold. [Examples](https://github.com/iovisor/bcc/blob/master/tools/dbslower_example.txt).
- tools/[dbstat](https://github.com/iovisor/bcc/blob/master/tools/dbstat.py): Summarize MySQL/PostgreSQL query latency as a histogram. [Examples](https://github.com/iovisor/bcc/blob/master/tools/dbstat_example.txt).

### postgres-bcc
èƒ½ä¸èƒ½ä¸ç”¨ dtrace è€Œåªä½¿ç”¨ eBPF çš„ uprobe æ¥è§‚æµ‹ pg çš„æŸ¥è¯¢å‘¢ï¼Ÿç­”æ¡ˆæ˜¯èƒ½çš„:

å°±åƒ mysql çš„æŸ¥è¯¢å…¥å£æ˜¯ dispatch_command ä¸€æ ·ï¼Œè¦ä½¿ç”¨ uprobe æ¥ trace çš„å‡½æ•°å…¥å£æ˜¯ exec_simple_query ä¹‹å‰åœ¨ GitHub ä¸ŠæŸ¥è¯¢ä¸€ä¸‹ï¼Œæœ€æ—©æŠŠ trace postgres å†™æˆåº”ç”¨çš„æ˜¯ [postgres-bcc](https://github.com/erthalion/postgres-bcc) ä½œè€…åº”ç”¨ bcc ä¸”ä¸ç”¨å¼€å¯ pg è‡ªå¸¦çš„ dtrace å†™äº†ä¸€ç³»åˆ— trace pg çš„å°å·¥å…·ï¼Œå·¥å…·åŒ…æ‹¬ï¼š

- Lock tracing(åŒ…æ‹¬ lwLock)
- Network usage
- WAL
- Filesystem(io)

è¿™ä¸ªé¡¹ç›®ç›¸æ¯” bcc examples å¯ä»¥è¯´æ˜¯éžå¸¸æˆç†Ÿï¼Œä½œè€…æŠŠ kprobe å’Œ uprobe ç»“åˆèµ·æ¥ï¼Œæ¥ä»Žç”¨æˆ·æ€å’Œå†…æ ¸æ€æ¥ä¸€èµ·è§‚æµ‹ pg, æ›´åŽ‰å®³çš„æ˜¯ï¼Œä½œè€…è¿˜å†™äº†ä¸€ç¯‡çš„æ–‡ç« ï¼š
- [PostgreSQL at low level: stay curious!](https://erthalion.info/2019/12/06/postgresql-stay-curious/)
![image](https://user-images.githubusercontent.com/15976103/215249027-5f8dc258-4626-4da0-b684-96e2502e1466.png)

- è¿˜æœ‰é…å¥—çš„è§†é¢‘ï¼šhttps://www.youtube.com/watch?v=5BEEQqcF6Ms
![image](https://user-images.githubusercontent.com/15976103/215251935-5fdc2642-35c9-4b10-ab0d-097f04739280.png)

### PGTracer

[PGTracer](https://github.com/aiven/pgtracer) æ˜¯ 2022 å¹´è¯žç”Ÿçš„ç¬¬ä¸€ä¸ª eBPF æ¥è§‚æµ‹ pg çš„ä¼ä¸šé¡¹ç›®ï¼Œæ¥è‡ª [aiven](https://github.com/aiven) è¿™ä¸ªå…¬å¸ï¼Œè¿™ä¸ªé¡¹ç›®çš„å®šä½ä¹Ÿå¾ˆæœ‰æ„æ€ä»Žæœ€å¼€å§‹çš„ perf å·¥å…·åˆ°çŽ°åœ¨çš„å·¥å…·é›†ï¼Œå®ƒä¼šæŠŠä¸€ä¸ªæŸ¥è¯¢çš„æ•´ä½“ä¿¡æ¯æ‰“å°å‡ºæ¥ï¼Œå¸®åŠ©å¤§å®¶è§‚å¯ŸæŸ¥è¯¢ï¼Œæ›´æœ‰æ„æ€çš„æ˜¯ï¼Œå®ƒè¿˜åŒ…æ‹¬äº†æŸ¥è¯¢è®¡åˆ’ï¼Œå¦‚å›¾ï¼š
- query:
![image](https://user-images.githubusercontent.com/15976103/215250937-a8f14655-2ed6-43ba-9328-0179fb7580d9.png)
- tracing result:
![image](https://user-images.githubusercontent.com/15976103/215250969-83bc562f-0be3-470e-9d24-7eff22aadd92.png)

### pg-lock-tracer

[pg-lock-tracer](https://github.com/jnidzwetzki/pg-lock-tracer) æ˜¯ 2023 å¹´è¯žç”Ÿçš„æ–°é¡¹ç›®ï¼Œä½œè€…æ˜¯è¿™ä¸ªé¡¹ç›®ä¸“æ³¨äºŽ trace pg ä¸­çš„å„ç§é”ï¼Œä½œè€…è¿˜æŠŠ lock å’Œ lwlock åŒºåˆ†å¼€æ¥ trace, è¿˜å¯ä»¥ç›´æŽ¥ç”Ÿæˆ dot å›¾ï¼Œæ–¹ä¾¿å­¦ä¹ ï¼Œè§‚æµ‹ä»¥åŠ debug.  
> **å¦‚æžœæƒ³å­¦ä¹  pg ä¸­çš„ lock è¿™ä¸ªé¡¹ç›®ä¹Ÿæ˜¯å¾ˆå¥½çš„åˆ‡å…¥ç‚¹**

![image](https://user-images.githubusercontent.com/15976103/215251244-33fd17f8-877b-4bc4-a9bb-146feb25f7c2.png)
- Lock statistics:
![image](https://user-images.githubusercontent.com/15976103/215251440-ee1c41c5-929d-4a59-a84a-97b13333b2a7.png)

- dot å›¾ï¼š
![image](https://user-images.githubusercontent.com/15976103/215252026-71ae2e43-d758-4d42-a5d6-81882226cb93.png)

ä½œè€… @jnidzwetzki è¿˜å†™äº†ä¸¤ç¯‡ä»‹ç»æ–‡ç« 
- [Trace PostgreSQL LWLocks with pg_lw_lock_tracer](https://jnidzwetzki.github.io/2023/01/17/trace-postgresql-lw-locks.html)
- [Trace PostgreSQL locks with pg_lock_tracer](https://jnidzwetzki.github.io/2023/01/11/trace-postgresql-locks-with-pg-lock-tracer.html)

## æˆ‘ä¹Ÿæƒ³å†™ä¸€ä¸ªå·¥å…·

å¦‚æžœå¤§å®¶ä¹Ÿæƒ³å†™ä¸€ä¸ªç±»ä¼¼çš„å·¥å…·å¦‚ä½•å…¥æ‰‹å‘¢ï¼Ÿ

æˆ‘åœ¨åŽ»å¹´ç»™ [ecapture](https://github.com/gojue/ecapture) æäº†ä¸€ä¸ªæ”¯æŒ pg çš„ PR å¤§å®¶å¯ä»¥å‚è€ƒï¼š

1. å­¦ä¹ ä¸€ç‚¹å‰ç½®çš„ eBPF çš„çŸ¥è¯†ï¼ŒçŸ¥é“ uprobe æ€Žä¹ˆç”¨
2. æŠŠä¸Šé¢çš„ä»»ä½•ä¸€ä¸ªé¡¹ç›®è¿è¡Œèµ·æ¥
3. é’ˆå¯¹ pg æ‰¾åˆ°ä½ æƒ³ trace çš„ç‚¹ï¼Œç„¶åŽæ‰¾åˆ°ç›¸å…³çš„å‡½æ•°ï¼Œåˆ©ç”¨ uprobe hook è¿™ä¸ªå‡½æ•°ï¼Œç”¨ eBPF æ‹¿åˆ°å‡½æ•°çš„å‚æ•°å€¼ï¼Œæ—¶é—´ï¼Œpid ç­‰ä¿¡æ¯ï¼Œåˆ©ç”¨è¿™äº›ä¿¡æ¯æ•´ç†å‡º trace çš„ç»“æžœ
4. å¦‚æžœéœ€è¦é…åˆ kprobe å¯ä»¥æŠŠè¿™äº›ç»“åˆåœ¨ä¸€èµ·
5. å­¦ä¹ ä¸€ç‚¹ bcc, å¯ä»¥ç›´æŽ¥å‚è€ƒæˆ‘ä¸Šé¢åˆ—å‡ºé¡¹ç›®çš„ä»£ç ï¼Œæ¥ hook è‡ªå·±æƒ³è¦çš„å‡½æ•°å’Œæƒ³è¦ trace çš„ç‚¹
6. å¦‚æžœç”¨ go çš„åŒå­¦å¯ä»¥æŠŠ bcc æ¢æˆ cilium

![image](https://user-images.githubusercontent.com/15976103/215252117-fc120557-5409-476f-8dd6-85b32e3df99e.png)

### æœªæ¥å±•æœ›

1. ä¸æ­¢æ˜¯ pg, çŽ°åœ¨å¾ˆå¤šæ•°æ®åº“å¯ä»¥ç›´æŽ¥ä½¿ç”¨ eBPF æ¥è¿›è¡Œè§‚æµ‹ï¼Œåƒ greenplum æ˜¯é»˜è®¤å¼€å¯ debug çš„ï¼Œè§‚æµ‹ä¼šæ›´æ–¹ä¾¿äº›
2. äº‘ä¸Šæ•°æ®åº“ç»“åˆ eBPF è§‚æµ‹æ„Ÿè§‰æœªæ¥ä¹Ÿä¼šæœ‰ä¸€äº›å¾ˆæ£’çš„é¡¹ç›®
3. Enjoy it

### 2024.06.13 æ›´æ–°

æœ‰äº†ä¸ªçœ‹èµ·æ¥éžå¸¸å¥½çš„æ–°é¡¹ç›®
https://github.com/ChrisBellew/pg-ferret
![image](https://github.com/yihong0618/gitblog/assets/15976103/8cae0a2f-369e-4e34-9036-457261187df2)


---

> æœ‰ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆè¦ä¸º PG ä¸“é—¨å†™ä¸€ä¸ª ebpf profilerï¼Œè€Œä¸ç”¨ä¹‹å‰çš„ dtrace å‘¢

1. å› ä¸º build-in dtrace æ”¯æŒçš„æœ‰é™ doc: https://www.postgresql.org/docs/current/dynamic-trace.html
2. å› ä¸ºæœ‰äº›ç³»ç»Ÿå®‰è£… dtrace ä¸ç®—å¤ªå®¹æ˜“ï¼Œæœ‰äº› postgres å‘è¡Œæ˜¯å¸¦ debug info çš„ï¼Œä½†å¸¦ dtrace çš„ä¸å¤š

---

> very good !
> 
> æ‰“ç®—å¥½å¥½æ•´æ•´ï¼Œä¸ºè‡ªå®¶DBå†™ä¸€å¥—å·¥å…·ï¼Œåˆ°æ—¶å€™æƒŠè‰³ä¸€ä¸‹ ðŸ˜„

æœ‰äº†ä¸ªæ–°é¡¹ç›®
https://github.com/ChrisBellew/pg-ferret